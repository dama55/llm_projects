<!DOCTYPE html>
<html>
<head>
  <title>LLM Stream</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #status {
      margin-top: 12px;
      font-weight: bold;
    }
    #output {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      max-height: 500px;
      overflow-y: auto;
    }
    .prompt {
      color: blue;
      font-weight: bold;
    }
    .response {
      color: green;
      white-space: pre-wrap; /* \n を自然に表示 */
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>LLM Stream Output</h1>

  <form id="generate-form">
    <label for="prompt">Enter your prompt:</label>
    <input type="text" id="prompt" name="prompt" required>
    <button type="submit" id="generate-btn">Generate</button>
  </form>

  <!-- ✅ 追加：状態表示 -->
  <div id="status"></div>

  <div id="output"></div>

  <script>
    const form = document.getElementById("generate-form");
    const output = document.getElementById("output");
    const status = document.getElementById("status");
    const btn = document.getElementById("generate-btn");

    let currentEventSource = null;

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const prompt = document.getElementById("prompt").value.trim();
      if (!prompt) {
        alert("Please enter a prompt.");
        return;
      }

      // 既に生成中なら前の接続を閉じる（多重送信防止）
      if (currentEventSource) {
        currentEventSource.close();
        currentEventSource = null;
      }

      // プロンプト表示
      const promptElement = document.createElement("div");
      promptElement.className = "prompt";
      promptElement.textContent = `Prompt: ${prompt}`;
      output.appendChild(promptElement);

      // 返信表示領域
      const responseElement = document.createElement("div");
      responseElement.className = "response";
      output.appendChild(responseElement);

      // UI状態
      status.textContent = "生成中…";
      btn.disabled = true;

      // EventSource開始
      const eventSource = new EventSource(`/generate_stream/?prompt=${encodeURIComponent(prompt)}`);
      currentEventSource = eventSource;

      eventSource.onmessage = (event) => {
        if (event.data === "[DONE]") {
          status.textContent = "完了";
          btn.disabled = false;
          eventSource.close();
          currentEventSource = null;
          return;
        }

        if (event.data.startsWith("Error:")) {
          status.textContent = "エラー";
          responseElement.textContent += "\n" + event.data;
          btn.disabled = false;
          eventSource.close();
          currentEventSource = null;
          return;
        }

        // ✅ 改行しないで連結（1文字ずつ来ても自然に繋がる）
        responseElement.textContent += event.data;

        // 自動スクロール（任意）
        output.scrollTop = output.scrollHeight;
      };

      eventSource.onerror = (err) => {
        console.error("EventSource failed:", err);
        status.textContent = "エラー";
        responseElement.textContent += "\nAn error occurred while generating the response.";
        btn.disabled = false;
        eventSource.close();
        currentEventSource = null;
      };
    });
  </script>
</body>
</html>